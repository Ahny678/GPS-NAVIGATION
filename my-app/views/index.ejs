<!DOCTYPE html>
<html>
  <head>
    <title>GPS Navigation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/stylesheets/style.css" />
  </head>
  <body>
    <div class="container">
      <h1><%= title %></h1>

      <h3>ESP32 Status</h3>
      <div class="status-list">
        <div class="status-item">
          <span class="label">Distance to obstacle:</span>
          <span class="value" id="gpsData"><%= espStatus.distance %> cm</span>
        </div>
        <div class="status-item">
          <span class="label">Distance to target:</span>
          <span class="value" id="targetDistance"
            ><%= espStatus.targetDistance %> meters</span
          >
        </div>
        <div class="status-item">
          <span class="label">Current GPS:</span>
          <span class="value" id="gpsCoords"
            >Lat=<%= espStatus.lat %>, Lon=<%= espStatus.lon %></span
          >
        </div>
        <div class="status-item">
          <span class="label">Target GPS:</span>
          <span class="value" id="targetCoords">
            <% if (espStatus.targetLat && espStatus.targetLon) { %> Lat=<%=
            espStatus.targetLat %>, Lon=<%= espStatus.targetLon %> <% } else {
            %> Not set <% } %>
          </span>
        </div>
        <div class="status-item">
          <span class="label">Yaw:</span>
          <span class="value" id="yaw"><%= espStatus.yaw %>¬∞</span>
        </div>
        <div class="status-item">
          <span class="label">Status:</span>
          <span class="value" id="status"><%= espStatus.status %></span>
        </div>
        <div class="status-item">
          <span class="label">Obstacle:</span>
          <span class="value" id="obstacle"><%= espStatus.obstacle %></span>
        </div>
        <div class="status-item">
          <span class="label">Satellites:</span>
          <span class="value" id="satellites"><%= espStatus.satellites %></span>
        </div>
        <div class="status-item">
          <span class="label">Map:</span>
          <span class="value" id="mapLink">
            <a
              href="https://www.google.com/maps?q=<%= espStatus.lat %>,<%= espStatus.lon %>"
              target="_blank"
              >View on Google Maps</a
            >
          </span>
        </div>
      </div>

      <!-- Set target section -->
      <div class="set-location">
        <h3>Set Target Location</h3>
        <div class="coord-row">
          <label for="latitude">Latitude:</label>
          <input
            type="number"
            id="latitude"
            step="any"
            placeholder="Enter latitude"
          />
          <label for="longitude">Longitude:</label>
          <input
            type="number"
            id="longitude"
            step="any"
            placeholder="Enter longitude"
          />
          <button id="setTarget">Set Target</button>
          <button id="useCurrentLocation">Use Current Coordinates</button>
        </div>
        <div
          id="targetStatus"
          style="margin-top: 10px; font-weight: bold"
        ></div>
      </div>

      <!-- Navigation controls -->
      <div class="navigation-controls" style="margin-top: 30px">
        <h3>Navigation Control</h3>
        <button id="startNav">Start</button>
        <button id="stopNav" style="background-color: #ff4444; color: white">
          Stop
        </button>
        <div id="navStatus" style="margin-top: 10px; font-weight: bold"></div>
      </div>

      <script>
        // --- Refresh ESP status ---
        setInterval(() => {
          fetch("/get-status")
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("gpsData").innerText =
                (data.distance ?? "N/A") + " cm";
              document.getElementById("targetDistance").innerText =
                (data.targetDistance ?? "N/A") + " meters";
              document.getElementById("gpsCoords").innerText =
                "Lat=" + (data.lat ?? "N/A") + ", Lon=" + (data.lon ?? "N/A");
              document.getElementById("targetCoords").innerText =
                data.targetLat && data.targetLon
                  ? `Lat=${data.targetLat}, Lon=${data.targetLon}`
                  : "Not set";
              document.getElementById("yaw").innerText =
                (data.yaw ?? "N/A") + "¬∞";
              document.getElementById("status").innerText =
                data.status ?? "Unknown";
              document.getElementById("obstacle").innerText =
                data.obstacle ?? "Unknown";
              document.getElementById("satellites").innerText =
                data.satellites ?? "N/A";
              document.getElementById(
                "mapLink"
              ).innerHTML = `<a href="https://www.google.com/maps?q=${data.lat},${data.lon}" target="_blank">View on Google Maps</a>`;
            })
            .catch((err) => console.error("Error fetching status:", err));
        }, 2000);

        // --- Set target manually (store only) ---
        document
          .getElementById("setTarget")
          .addEventListener("click", async () => {
            const latitude = parseFloat(
              document.getElementById("latitude").value
            );
            const longitude = parseFloat(
              document.getElementById("longitude").value
            );
            const statusBox = document.getElementById("targetStatus");

            if (isNaN(latitude) || isNaN(longitude)) {
              statusBox.innerText = "‚ùå Invalid coordinates.";
              return;
            }

            try {
              const res = await fetch("/set-target", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ latitude, longitude }),
              });
              const data = await res.json();
              statusBox.innerText = res.ok
                ? `‚úÖ Target stored (Lat=${latitude}, Lon=${longitude})`
                : `‚ùå ${data.message || "Failed to set target"}`;
            } catch {
              statusBox.innerText = "‚ùå Network error.";
            }
          });

        // --- Use current coordinates (store only) ---
        document
          .getElementById("useCurrentLocation")
          .addEventListener("click", () => {
            const statusBox = document.getElementById("targetStatus");
            if (!navigator.geolocation) {
              statusBox.innerText = "‚ùå Geolocation not supported.";
              return;
            }

            navigator.geolocation.getCurrentPosition(
              async (pos) => {
                const latitude = pos.coords.latitude;
                const longitude = pos.coords.longitude;
                try {
                  const res = await fetch("/set-target", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ latitude, longitude }),
                  });
                  const data = await res.json();
                  statusBox.innerText = res.ok
                    ? `‚úÖ Current location stored as target (Lat=${latitude}, Lon=${longitude})`
                    : `‚ùå ${data.message || "Failed to set location"}`;
                } catch {
                  statusBox.innerText = "‚ùå Network error.";
                }
              },
              (err) => {
                statusBox.innerText = "‚ùå Error: " + err.message;
              }
            );
          });

        // --- Start navigation (calculate + activate) ---
        document
          .getElementById("startNav")
          .addEventListener("click", async () => {
            const navStatus = document.getElementById("navStatus");
            navStatus.innerText = "‚è≥ Calculating route...";
            try {
              // Get stored target
              const currentStatus = await fetch("/get-status").then((r) =>
                r.json()
              );
              if (!currentStatus.targetLat || !currentStatus.targetLon) {
                navStatus.innerText = "‚ùå No target set.";
                return;
              }

              // Step 1: Calculate route or direct path
              const res1 = await fetch("/send-coordinates", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  latitude: currentStatus.targetLat,
                  longitude: currentStatus.targetLon,
                }),
              });
              const routeData = await res1.json();
              if (!res1.ok) {
                navStatus.innerText =
                  "‚ùå " + (routeData.message || "Failed to calculate route.");
                return;
              }

              // Step 2: Start navigation
              navStatus.innerText = "‚úÖ Route ready. Starting navigation...";
              const res2 = await fetch("/start-navigation", { method: "POST" });
              const startData = await res2.json();
              navStatus.innerText = res2.ok
                ? "üöÄ " + startData.message
                : "‚ùå " + (startData.message || "Failed to start navigation.");
            } catch (err) {
              navStatus.innerText = "‚ùå " + err.message;
            }
          });

        // --- Stop navigation ---
        document
          .getElementById("stopNav")
          .addEventListener("click", async () => {
            const navStatus = document.getElementById("navStatus");
            navStatus.innerText = "‚è≥ Stopping navigation...";
            try {
              const res = await fetch("/stop-navigation", { method: "POST" });
              const data = await res.json();
              navStatus.innerText = res.ok
                ? "üõë " + data.message
                : "‚ùå " + (data.message || "Failed to stop.");
            } catch {
              navStatus.innerText = "‚ùå Network error.";
            }
          });
      </script>
    </div>
  </body>
</html>
